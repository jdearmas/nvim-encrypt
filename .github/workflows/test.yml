name: Test nvim-encrypt

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y neovim gpg
        
    - name: Install latest Neovim
      run: |
        curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux64.tar.gz
        sudo tar -C /opt -xzf nvim-linux64.tar.gz
        sudo ln -sf /opt/nvim-linux64/bin/nvim /usr/local/bin/nvim
        nvim --version
        
    - name: Set up test dependencies
      run: make setup-tests
    
    - name: Run comprehensive tests
      run: make test
      
    - name: Verify test artifacts cleanup
      run: |
        # Ensure no test artifacts are left behind
        if find /tmp -name "*nvim_encrypt*" -o -name "*gpg_test*" 2>/dev/null | grep -q .; then
          echo "Warning: Test artifacts found in /tmp"
          find /tmp -name "*nvim_encrypt*" -o -name "*gpg_test*" 2>/dev/null || true
        else
          echo "âœ“ No test artifacts found - cleanup successful"
        fi